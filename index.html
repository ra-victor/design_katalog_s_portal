<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intranät | Koncernövergripande Resursallokering (SECURE)</title>
    <style>
        :root {
            --bg-body: #e0e5ec;
            --bg-panel: #ecf0f3;
            --text-main: #4a5568;
            --text-muted: #a0aec0;
            --border-light: #ffffff;
            --border-shadow: #b8b9be;
            --accent: #4a90e2;
            --danger: #e53e3e;
            --success: #38a169;
            --warning: #d69e2e;
            --mono: 'Menlo', 'Monaco', 'Courier New', monospace;
            --sans: 'Segoe UI', system-ui, sans-serif;
        }

        /* --- NEUMORPHIC BASE --- */
        body {
            background-color: var(--bg-body);
            font-family: var(--sans);
            color: var(--text-main);
            margin: 0;
            padding: 20px 0 100px 0;
            line-height: 1.5;
        }

        .container { max-width: 850px; margin: 0 auto; padding: 0 15px; }

        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #cbd5e0;
            padding-bottom: 20px;
        }
        .header h1 { font-size: 1.25rem; text-transform: uppercase; letter-spacing: 2px; margin: 0; color: #2d3748; }
        .header .meta { font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }

        .module {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 9px 9px 16px var(--border-shadow), -9px -9px 16px var(--border-light);
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.4);
        }

        .module-head {
            display: flex; justify-content: space-between; align-items: baseline;
            margin-bottom: 20px; border-bottom: 1px solid #cbd5e0; padding-bottom: 10px;
        }
        .label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #718096; }
        .status-led { height: 8px; width: 8px; border-radius: 50%; background: #cbd5e0; display: inline-block; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); }
        .status-led.active { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .control-panel {
            background: #e6e9ef;
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 3px 3px 7px rgba(163,177,198, 0.6), inset -3px -3px 7px rgba(255,255,255, 0.5);
        }

        /* --- COMPONENTS --- */
        button {
            font-family: var(--mono); font-weight: bold; font-size: 0.8rem;
            color: var(--text-main); background: var(--bg-panel);
            border: none; border-radius: 6px; padding: 10px 15px;
            box-shadow: 4px 4px 8px var(--border-shadow), -4px -4px 8px var(--border-light);
            cursor: pointer; transition: all 0.1s ease; outline: none; text-transform: uppercase;
        }
        button:active { box-shadow: inset 2px 2px 5px var(--border-shadow), inset -2px -2px 5px var(--border-light); transform: translateY(1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.primary { color: var(--accent); }
        button.danger { color: var(--danger); }

        .display-field {
            font-family: var(--mono); background: #2d3748; color: #63b3ed;
            padding: 10px; border-radius: 4px; text-align: center;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); margin-bottom: 15px;
            min-height: 40px; display: flex; align-items: center; justify-content: center;
            letter-spacing: 2px; white-space: pre-wrap; word-break: break-all;
        }

        /* --- 1. FLYWHEEL --- */
        .flywheel-wrap { display: flex; gap: 20px; align-items: center; }
        .wheel-container { position: relative; width: 140px; height: 140px; flex-shrink: 0; }
        .marker { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid var(--danger); z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        
        /* --- 2. DRIFT --- */
        .radar-screen { 
            width: 100%; height: 180px; background: #000; position: relative; 
            overflow: hidden; cursor: crosshair; margin-bottom: 10px; border: 2px solid #4a5568;
        }
        .radar-grid { 
            width: 100%; height: 100%; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(2, 1fr);
            background-image: linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .radar-cell { display: flex; align-items: center; justify-content: center; color: rgba(0,255,0,0.3); font-family: var(--mono); font-size: 1.5rem; border: 1px solid rgba(0,255,0,0.1); }
        .blip { width: 8px; height: 8px; background: #0f0; border-radius: 50%; position: absolute; box-shadow: 0 0 10px #0f0; transform: translate(-50%, -50%); }
        .knob-row { display: flex; justify-content: space-around; align-items: center; margin-top: 15px; }
        .knob { 
            width: 50px; height: 50px; border-radius: 50%; background: var(--bg-panel);
            box-shadow: 5px 5px 10px var(--border-shadow), -5px -5px 10px var(--border-light);
            position: relative; cursor: ns-resize; transform: rotate(0deg);
        }
        .knob::after { content: ''; position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 4px; height: 12px; background: var(--text-muted); border-radius: 2px; }
        
        /* --- 4. SPINNER --- */
        .char-slot { font-size: 3rem; color: var(--text-main); font-weight: bold; height: 80px; display: flex; align-items: center; justify-content: center; background: #e2e8f0; border-radius: 6px; margin-bottom: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        
        /* --- 5. GEO --- */
        .map-frame { height: 180px; background: #fff; border: 1px solid #cbd5e0; position: relative; overflow: hidden; margin-bottom: 15px; background-image: radial-gradient(#cbd5e0 1px, transparent 1px); background-size: 20px 20px; }
        .drone-pin { width: 12px; height: 12px; background: var(--danger); position: absolute; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: translate(-50%, -50%); transition: top 0.2s linear, left 0.2s linear; }
        .slider-group { display: flex; flex-direction: column; gap: 10px; }
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--bg-panel); border: 1px solid var(--border-shadow); box-shadow: 2px 2px 4px var(--border-shadow), -2px -2px 4px var(--border-light); margin-top: -6px; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #cbd5e0; border-radius: 2px; }

        /* --- 7. GRAVITY --- */
        .gravity-well { height: 200px; background: #edf2f7; border-radius: 50px; width: 60px; margin: 0 auto; position: relative; border: 1px solid #cbd5e0; box-shadow: inset 2px 2px 6px rgba(0,0,0,0.1); }
        .mercury-bead { width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #718096); border-radius: 50%; position: absolute; left: 9px; cursor: grab; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .mercury-bead:active { cursor: grabbing; }

        /* --- 8. OUIJA --- */
        .spectral-pad { background: #2d3748; padding: 10px; border-radius: 6px; height: 200px; position: relative; cursor: none; overflow: hidden; }
        .spectral-char { position: absolute; color: rgba(255,255,255,0.2); font-family: serif; font-size: 14px; user-select: none; }
        .planchette { width: 40px; height: 50px; border: 2px solid rgba(255,255,255,0.8); border-radius: 50% 50% 5px 5px; position: absolute; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .planchette::after { content: ''; width: 6px; height: 6px; border: 1px solid #fff; border-radius: 50%; }

        /* --- 10. HEAT --- */
        .rub-zone { 
            height: 120px; background: repeating-linear-gradient(45deg, #e2e8f0, #e2e8f0 10px, #edf2f7 10px, #edf2f7 20px);
            border: 2px dashed #cbd5e0; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            cursor: grab; margin-bottom: 15px; position: relative; overflow: hidden; user-select: none;
        }
        .rub-zone:active { cursor: grabbing; border-color: var(--accent); border-style: solid; }
        .heat-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, rgba(229,62,62,0.8), transparent); pointer-events: none; transition: height 0.05s; }
        .temp-gauge { height: 10px; background: #cbd5e0; border-radius: 5px; overflow: hidden; position: relative; margin-top: 5px; }
        .temp-fill { height: 100%; background: linear-gradient(90deg, #3498db, #e74c3c); width: 0%; transition: width 0.1s linear; }
        .target-zone { position: absolute; left: 75%; width: 15%; height: 100%; background: rgba(56, 161, 105, 0.5); border-left: 1px solid #fff; border-right: 1px solid #fff; }

        .submit-block { margin-top: 50px; padding: 20px; text-align: center; opacity: 0.5; pointer-events: none; transition: all 0.5s; filter: grayscale(1); }
        .submit-block.ready { opacity: 1; pointer-events: all; filter: grayscale(0); }
        .final-btn { width: 100%; padding: 20px; font-size: 1rem; letter-spacing: 2px; background: var(--success); color: white; border: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="container">
            <h1>HR-Portal v7.0.2 (RC4)</h1>
            <div class="meta">Protokoll: SEC-HARDENED | Session ID: 0x9F3A</div>
        </div>
    </div>

    <div class="container">

        <!-- 1. NAME - INERTIA -->
        <div class="module">
            <div class="module-head">
                <span class="label">1. Användaridentitet (Roterande Inmatning)</span>
                <span class="status-led" id="led1"></span>
            </div>
            <div class="control-panel flywheel-wrap">
                <div class="wheel-container">
                    <div class="marker"></div>
                    <canvas id="canvasWheel" width="140" height="140"></canvas>
                </div>
                <div style="flex:1;">
                    <div class="display-field" id="outName"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <button class="primary" id="btnSpin">Inducera</button>
                        <button class="danger" id="btnBrake">Friktion</button>
                    </div>
                    <button style="width:100%" id="btnStamp">Stämpla Tecken</button>
                </div>
            </div>
        </div>

        <!-- 2. PHONE - VECTOR -->
        <div class="module">
            <div class="module-head">
                <span class="label">2. Kontaktvektor (XY-Låsning)</span>
                <span class="status-led" id="led2"></span>
            </div>
            <div class="control-panel">
                <div class="display-field" id="outPhone">__-_______</div>
                <div class="radar-screen" id="radar">
                    <div class="radar-grid" id="radarGrid"></div>
                    <div class="blip" id="blip"></div>
                </div>
                <div class="knob-row">
                    <div style="text-align:center">
                        <div class="knob" id="knobX"></div>
                        <span class="label" style="margin-top:5px; display:block">LAT</span>
                    </div>
                    <button style="height:60px; width:60px; border-radius:50%; font-size:10px;" id="btnPing">LÅS<br>SIGNAL</button>
                    <div style="text-align:center">
                        <div class="knob" id="knobY"></div>
                        <span class="label" style="margin-top:5px; display:block">LONG</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. DATE - BINARY -->
        <div class="module">
            <div class="module-head">
                <span class="label">3. Period (Binär Sortering)</span>
                <span class="status-led" id="led3"></span>
            </div>
            <div class="control-panel" style="text-align:center;">
                <div class="display-field" id="dateDisp" style="font-size:1.5rem; color:#4a5568; background:#cbd5e0;">2024-06-15</div>
                <div style="font-family:var(--mono); font-size:0.7rem; color:var(--text-muted); margin-bottom:15px;">ITERATIONER: <span id="dateIter">0</span></div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button id="btnLess">&lt; FÖREGÅENDE</button>
                    <button class="success" style="color:var(--success)" id="btnConfirmDate">BEKRÄFTA</button>
                    <button id="btnMore">NÄSTKOMMANDE &gt;</button>
                </div>
            </div>
        </div>

        <!-- 4. CODE - ROULETTE -->
        <div class="module">
            <div class="module-head">
                <span class="label">4. Auktoriseringskod (Sekventiell)</span>
                <span class="status-led" id="led4"></span>
            </div>
            <div class="control-panel" style="text-align:center;">
                <div class="display-field" id="codeOut" style="letter-spacing:5px;">_ _ _ _</div>
                <div class="char-slot" id="charSpinner">A</div>
                <div style="height:4px; background:#cbd5e0; width:100%; margin-bottom:15px;"><div id="spinTimeBar" style="height:100%; width:100%; background:var(--accent);"></div></div>
                <button class="primary" style="width:100%" id="btnLockChar">LÅS TECKEN (EXAKT)</button>
            </div>
        </div>

        <!-- 5. GEO - WIND -->
        <div class="module">
            <div class="module-head">
                <span class="label">5. Leveranskoordinater (Atmosfärisk Kompensation)</span>
                <span class="status-led" id="led5"></span>
            </div>
            <div class="control-panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span class="label">DRÖNARE: ONLINE</span>
                    <span class="label" id="windLabel" style="color:var(--danger)">VIND: 12 m/s NV</span>
                </div>
                <div class="map-frame" id="geoMap">
                    <div class="drone-pin" id="dronePin"></div>
                </div>
                <div class="display-field" style="font-size:0.8rem; height:auto; padding:5px;">LAT: <span id="latVal">0.000</span> | LON: <span id="lonVal">0.000</span></div>
                <div class="slider-group">
                    <input type="range" id="slideLat" min="0" max="100" step="0.1">
                    <input type="range" id="slideLon" min="0" max="100" step="0.1">
                </div>
                <button style="width:100%; margin-top:15px;" id="btnDrop">BEGÄR LEVERANS HÄR</button>
            </div>
        </div>

        <!-- 7. VOLUME - GRAVITY -->
        <div class="module">
            <div class="module-head">
                <span class="label">6. Notisvolym (Kvicksilver)</span>
                <span class="status-led" id="led7"></span>
            </div>
            <div class="control-panel" style="display:flex; align-items:center; gap:30px;">
                <div class="gravity-well" id="gravTrack">
                    <div class="mercury-bead" id="bead"></div>
                </div>
                <div style="flex:1; text-align:center;">
                    <span class="label">NIVÅ</span>
                    <div class="display-field" id="volDisplay" style="font-size:2rem; margin-top:10px;">50%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted); margin-top:10px;">Håll musen stilla för stabilisering.</div>
                </div>
            </div>
        </div>

        <!-- 8. EMAIL - OUIJA -->
        <div class="module">
            <div class="module-head">
                <span class="label">7. E-post (Spektral Analys)</span>
                <span class="status-led" id="led8"></span>
            </div>
            <div class="control-panel">
                <div class="display-field" id="emailOut"></div>
                <div class="spectral-pad" id="ouijaBoard">
                    <div class="planchette" id="planchette"></div>
                </div>
                <div style="text-align:center; margin-top:10px; font-size:0.7rem; color:var(--text-muted);">
                    Mediets motstånd är normalt. Tvinga markören till tecknen.
                </div>
            </div>
        </div>

        <!-- 10. HEAT - APPROVAL -->
        <div class="module submit-block" id="finalModule">
            <div class="module-head">
                <span class="label">8. KRYPTERING AV REKVISITION</span>
            </div>
            <div class="control-panel">
                <div class="rub-zone" id="rubPad">
                    <div style="z-index:2; font-weight:bold; color:#718096; text-transform:uppercase;">Generera Entropi (Gnugga)</div>
                    <div class="heat-overlay" id="heatOverlay"></div>
                </div>
                <div class="temp-gauge">
                    <div class="target-zone"></div>
                    <div class="temp-fill" id="tempBar"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; margin-top:5px; font-family:var(--mono);">
                    <span>SYSTEMTEMP</span>
                    <span id="cryptoStatus">VÄNTAR...</span>
                </div>
                <div style="height:4px; background:#e2e8f0; width:100%; margin-top:15px; border-radius:2px;"><div id="progBar" style="height:100%; background:var(--text-main); width:0%;"></div></div>
            </div>
            <br>
            <button class="final-btn" id="btnSubmit" disabled>SIGNERA & SKICKA</button>
        </div>

    </div>

    <script>
        // --- CORE UTILS ---
        const rAF = requestAnimationFrame;
        const clamp = (v,min,max) => Math.max(min,Math.min(max,v));
        
        // GLOBAL STATE
        const state = {
            name: "",
            phone: "",
            dateConfirmed: false,
            code: "",
            geoLocked: false,
            volLocked: false,
            email: ""
        };

        const checkGlobal = () => {
            // Check if all previous steps (simplified logic for demo) are loosely "active"
            // For this UI demo, we enable the final step always but it requires interaction
            document.getElementById('finalModule').classList.add('ready');
        };

        // --- 1. FLYWHEEL ---
        (() => {
            const canvas = document.getElementById('canvasWheel');
            const ctx = canvas.getContext('2d');
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ ÅÄÖ".split("");
            const segment = (Math.PI * 2) / chars.length;
            let angle = 0, v = 0, dragging = false;

            document.getElementById('btnSpin').addEventListener('mousedown', () => v += 0.05);
            document.getElementById('btnBrake').addEventListener('mousedown', () => v *= 0.85);

            function draw() {
                v *= 0.992; // Friction
                angle += v;
                ctx.clearRect(0,0,140,140);
                ctx.save(); ctx.translate(70,70); ctx.rotate(angle);
                
                ctx.beginPath(); ctx.arc(0,0,65,0,Math.PI*2);
                ctx.fillStyle = "#edf2f7"; ctx.fill(); ctx.strokeStyle = "#cbd5e0"; ctx.stroke();

                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillStyle = "#4a5568"; ctx.font = "bold 12px Menlo";
                
                chars.forEach((c, i) => {
                    ctx.save();
                    const th = i * segment;
                    ctx.rotate(th); ctx.translate(0, -52); ctx.rotate(-angle - th);
                    ctx.fillText(c, 0, 0);
                    ctx.restore();
                });
                ctx.restore();
                rAF(draw);
            }
            draw();

            document.getElementById('btnStamp').onclick = () => {
                if(Math.abs(v) > 0.02) { 
                    document.getElementById('outName').style.color = "var(--danger)";
                    setTimeout(()=>document.getElementById('outName').style.color = "#63b3ed", 200);
                    return; 
                }
                let norm = (angle % (Math.PI*2)); if (norm < 0) norm += Math.PI*2;
                let idx = Math.round(norm / segment);
                let char = chars[(chars.length - idx) % chars.length];
                state.name += char;
                document.getElementById('outName').textContent = state.name;
                if(state.name.length > 3) document.getElementById('led1').classList.add('active');
            };
        })();

        // --- 2. DRIFT RADAR ---
        (() => {
            const blip = document.getElementById('blip');
            const disp = document.getElementById('outPhone');
            const grid = document.getElementById('radarGrid');
            const nums = [1,2,3,4,5,6,7,8,9,0];
            
            nums.forEach(n => {
                let d = document.createElement('div');
                d.className = 'radar-cell'; d.innerText = n;
                grid.appendChild(d);
            });

            let px=50, py=50, vx=0, vy=0, tx=0, ty=0;
            
            // Knobs
            const bindKnob = (id, axis) => {
                let el = document.getElementById(id);
                let lastY = 0;
                el.onmousedown = e => {
                    lastY = e.clientY;
                    const move = mv => {
                        let delta = lastY - mv.clientY; lastY = mv.clientY;
                        let r = parseFloat(el.style.transform.replace('rotate(',''))||0;
                        el.style.transform = `rotate(${r+delta*2}deg)`;
                        if(axis==='x') tx += delta * 0.05;
                        else ty += delta * 0.05;
                    };
                    const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
                    window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
                };
            };
            bindKnob('knobX', 'x'); bindKnob('knobY', 'y');

            function loop() {
                // Decay target velocity (auto-centering knobs logic essentially)
                tx *= 0.98; ty *= 0.98;
                
                // Add noise
                vx += (tx * 0.02) + (Math.random()-0.5)*0.1;
                vy += (ty * 0.02) + (Math.random()-0.5)*0.1;
                
                px += vx; py += vy;
                
                // Bounce
                if(px<0||px>100) { vx*=-0.7; px=clamp(px,0,100); }
                if(py<0||py>100) { vy*=-0.7; py=clamp(py,0,100); }

                blip.style.left = px+"%"; blip.style.top = py+"%";
                rAF(loop);
            }
            loop();

            document.getElementById('btnPing').onclick = () => {
                let col = Math.floor(px / 20);
                let row = Math.floor(py / 50);
                let idx = row*5 + col;
                if(idx >= 0 && idx < 10) {
                    let n = nums[idx];
                    state.phone += n;
                    disp.textContent = state.phone;
                    if(state.phone.length > 5) document.getElementById('led2').classList.add('active');
                }
            };
        })();

        // --- 3. BINARY DATE ---
        (() => {
            let min = new Date('2020-01-01').getTime();
            let max = new Date('2030-01-01').getTime();
            let cur = (min+max)/2;
            let iter = 0;
            const disp = document.getElementById('dateDisp');
            const count = document.getElementById('dateIter');

            const update = () => {
                let d = new Date(cur);
                disp.textContent = d.toISOString().split('T')[0];
                count.textContent = iter;
            };

            document.getElementById('btnLess').onclick = () => { iter++; max = cur; cur = (min+max)/2; update(); };
            document.getElementById('btnMore').onclick = () => { iter++; min = cur; cur = (min+max)/2; update(); };
            document.getElementById('btnConfirmDate').onclick = () => {
                document.getElementById('led3').classList.add('active');
                disp.style.border = "2px solid var(--success)";
            };
        })();

        // --- 4. ROULETTE CODE ---
        (() => {
            const chars = "0123456789";
            const el = document.getElementById('charSpinner');
            const out = document.getElementById('codeOut');
            const bar = document.getElementById('spinTimeBar');
            let idx = 0, speed = 100, last = 0;

            function cycle(t) {
                if(t - last > speed) {
                    idx = (idx + 1) % chars.length;
                    el.textContent = chars[idx];
                    last = t;
                    // Visualize speed
                    bar.style.width = (speed/3)+"%";
                }
                rAF(cycle);
            }
            rAF(cycle);

            document.getElementById('btnLockChar').onclick = () => {
                state.code += chars[idx];
                out.textContent = state.code;
                speed = Math.max(10, speed * 0.7); // Faster every time
                if(state.code.length >= 4) document.getElementById('led4').classList.add('active');
            };
        })();

        // --- 5. GEO WIND ---
        (() => {
            const pin = document.getElementById('dronePin');
            const lbl = document.getElementById('windLabel');
            let lat=50, lon=50, wLat=0, wLon=0;
            let windDirX = 0, windDirY = 0;

            // Change wind every 2 sec
            setInterval(() => {
                windDirX = (Math.random()-0.5) * 0.8;
                windDirY = (Math.random()-0.5) * 0.8;
                lbl.textContent = `VIND: ${(Math.abs(windDirX)*20).toFixed(1)} m/s ${(windDirY>0?'N':'S')}`;
            }, 2000);

            function loop() {
                // Inputs
                let inLat = parseFloat(document.getElementById('slideLat').value);
                let inLon = parseFloat(document.getElementById('slideLon').value);
                
                wLat += (inLat - 50) * 0.05 + windDirX;
                wLon += (inLon - 50) * 0.05 + windDirY;

                // Drift
                lat += wLat * 0.01; 
                lon += wLon * 0.01;

                // Bounds
                if(lat<0) lat=0; if(lat>100) lat=100;
                if(lon<0) lon=0; if(lon>100) lon=100;

                // Dampen inputs to simulate sliders returning to center virtually
                // Actually, let's just make the user fight the wind directly with the sliders acting as "thrust"
                
                pin.style.top = (100-lat) + "%";
                pin.style.left = lon + "%";

                document.getElementById('latVal').textContent = lat.toFixed(3);
                document.getElementById('lonVal').textContent = lon.toFixed(3);
                rAF(loop);
            }
            loop();

            document.getElementById('btnDrop').onclick = () => {
                document.getElementById('led5').classList.add('active');
            };
        })();

        // --- 7. GRAVITY VOLUME ---
        (() => {
            const bead = document.getElementById('bead');
            const well = document.getElementById('gravTrack');
            let y = 10, vy = 0;
            
            // Mouse gravity
            let my = 0;
            well.onmousemove = e => {
                let rect = well.getBoundingClientRect();
                my = e.clientY - rect.top;
            };

            function sim() {
                // Gravity pulls down
                vy += 0.5;
                // Mouse repels (Anti-gravity glove)
                let d = (y+20) - my;
                if(Math.abs(d) < 80) {
                    vy -= (80-Math.abs(d)) * 0.05 * Math.sign(d);
                }

                y += vy;
                
                // Floor/Ceiling bounce
                if(y > 160) { y=160; vy *= -0.6; }
                if(y < 0) { y=0; vy *= -0.6; }

                bead.style.top = y + "px";
                let vol = Math.round(100 - (y/160)*100);
                document.getElementById('volDisplay').textContent = vol + "%";
                
                if(Math.abs(vy) < 0.1) {
                    document.getElementById('led7').classList.add('active');
                } else {
                    document.getElementById('led7').classList.remove('active');
                }
                rAF(sim);
            }
            sim();
        })();

        // --- 8. OUIJA ---
        (() => {
            const board = document.getElementById('ouijaBoard');
            const planch = document.getElementById('planchette');
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ@.com".split("");
            
            // Randomly scatter chars
            chars.forEach(c => {
                let el = document.createElement('div');
                el.className = 'spectral-char';
                el.textContent = c;
                el.style.left = (10 + Math.random()*80) + "%";
                el.style.top = (10 + Math.random()*80) + "%";
                board.appendChild(el);
            });

            let mx=100, my=100, px=100, py=100;
            
            board.onmousemove = e => {
                let r = board.getBoundingClientRect();
                mx = e.clientX - r.left;
                my = e.clientY - r.top;
            };

            function spirit() {
                // Extremely laggy follow with noise
                let dx = mx - px;
                let dy = my - py;
                
                px += dx * 0.02 + (Math.random()-0.5)*2;
                py += dy * 0.02 + (Math.random()-0.5)*2;

                planch.style.left = px + "px";
                planch.style.top = py + "px";

                // Detection
                let detected = null;
                Array.from(document.querySelectorAll('.spectral-char')).forEach(el => {
                    let r = el.getBoundingClientRect();
                    let pr = planch.getBoundingClientRect();
                    let cx = r.left + r.width/2;
                    let cy = r.top + r.height/2;
                    let pcx = pr.left + pr.width/2;
                    let pcy = pr.top + pr.height/2;
                    
                    if(Math.hypot(cx-pcx, cy-pcy) < 10) {
                        el.style.color = "#fff";
                        el.style.textShadow = "0 0 5px #fff";
                        if(Math.random() > 0.95) { // Slow typing
                            state.email += el.textContent;
                            document.getElementById('emailOut').textContent = state.email;
                            if(state.email.includes("@")) document.getElementById('led8').classList.add('active');
                        }
                    } else {
                        el.style.color = "rgba(255,255,255,0.2)";
                        el.style.textShadow = "none";
                    }
                });

                rAF(spirit);
            }
            spirit();
        })();

        // --- 10. HEAT SINK ---
        (() => {
            const pad = document.getElementById('rubPad');
            const ov = document.getElementById('heatOverlay');
            const tBar = document.getElementById('tempBar');
            const pBar = document.getElementById('progBar');
            const stat = document.getElementById('cryptoStatus');
            const btn = document.getElementById('btnSubmit');

            let temp = 0;
            let progress = 0;
            let lx=0, ly=0, active=false;

            pad.onmousedown = e => { active=true; lx=e.clientX; ly=e.clientY; };
            window.onmouseup = () => active=false;
            window.onmousemove = e => {
                if(!active) return;
                let d = Math.hypot(e.clientX-lx, e.clientY-ly);
                temp += d * 0.5; // Generate heat
                lx = e.clientX; ly = e.clientY;
            };

            function thermodynamics() {
                // Cooling (aggressive)
                temp -= 1.5;
                if(temp < 0) temp = 0;
                
                // Logic
                let valid = (temp > 75 && temp < 90); // Green zone is narrow
                
                if(valid) {
                    progress += 0.2;
                    stat.textContent = "KRYPTERAR...";
                    stat.style.color = "var(--success)";
                } else {
                    if(progress > 0) progress -= 0.1; // Decay progress if not in zone
                    if(temp >= 90) {
                        stat.textContent = "ÖVERHETTNING - KYLER NER";
                        stat.style.color = "var(--danger)";
                        progress = 0; // Penalty
                    } else {
                        stat.textContent = "FÖR LÅG ENTROPI";
                        stat.style.color = "var(--text-muted)";
                    }
                }
                
                progress = clamp(progress, 0, 100);

                // UI
                ov.style.height = clamp(temp,0,100) + "%";
                tBar.style.width = clamp(temp,0,100) + "%";
                pBar.style.width = progress + "%";

                if(progress >= 100) {
                    btn.disabled = false;
                    btn.textContent = "GODKÄND - SKICKA";
                    stat.textContent = "NYCKEL GENERERAD";
                }

                rAF(thermodynamics);
            }
            rAF(thermodynamics);
            
            btn.onclick = () => {
                alert("SYSTEMFEL: Det går inte att ansluta till servern (Timeout). Var god fyll i formuläret igen.");
                location.reload();
            };
        })();

        // Start
        checkGlobal();
    </script>
</body>
</html>
